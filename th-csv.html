<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">

<polymer-element name="th-csv" attributes="url output" thelma>

  <template>
    <style>
        #ctrl_collapse {
          width: 250px;
        }
        .elTitle {
          color: #2fa3af;
          padding: 2px;
        }
        label {
          color: #2fa3af;
        }
        core-input {
          border: 1px solid #eee;
          padding: 2px;
        }



    </style>

    <core-icon-button icon="perm-data-setting" on-click="{{showControls}}"></core-icon-button>


    <core-collapse id="ctrl_collapse">
      <label class="label">Source</label><input is="core-input" value="{{url}}" placeHolder="http://sepans.com/misc/test.csv">

    </core-collapse>
  </template>
  

  <script src="../d3/d3.min.js"></script> 
  <script>

      Polymer('th-csv', {
        url: '',
        output: null,

        ready: function() {
          var self = this;

        },
        urlChanged: function() {
          var self = this;

          this._makeCORSCall(this.url);

          

          //var corsurl = self.url.replace(/(ftp|http|https):\/\//,'http://www.corsproxy.com/');
          //var corsurl = 'http://whateverorigin.org/get?url='+self.url;
          //self.$.ajax.url = corsurl;
          //console.log(corsurl);

          // d3.csv(corsurl, function(d) {
          //   console.log(d);
          //   self.data = d;
          //   self.filterCsv();
          // });
        },
/*
        filterCsv: function() {
          var self = this;
          if(self.data) {
              if(self.filter_row_from>0 || self.filter_row_to>0 || self.filter_col_from>0 || self.filter_col_to>0) {
                var from = self.filter_row_from>0 ? self.filter_row_from : 1;
                var to = self.filter_row_to>0 ? self.filter_row_to : self.data.length + 1;

                var fromCol = self.filter_col_from>0 ? self.filter_col_from : 1;
                var toCol = self.filter_col_to>0 ? self.filter_col_to : self.data.length + 1;

                console.log(fromCol);

                self.output = self.data.filter(function(d, i) {
                    if(i + 1>= from  && i + 1<= to  ) {
                      console.log(i);
                      return d;
                    }
                });
                self.output = self.output.map(function(d, i) {
                      
                      var copy = {}; //JSON.parse(JSON.stringify(d));
                      var colIndex = 0;
                      for(key in d) {
                        if(colIndex + 1>= fromCol  && colIndex + 1<= toCol  ) {
                          copy[key] = d[key];
                        }


                        colIndex++;

                      }
                      console.log(copy);
                      return copy;
                });

              }
              else {
                self.output = self.data;
              }
          }
        },

*/
      _makeCORSCall: function(url, iscors) {

            var self = this;
            var method = 'GET';
            var xhr = new XMLHttpRequest();
            if ("withCredentials" in xhr) {
              xhr.open(method, url, true);
            } else if (typeof XDomainRequest != "undefined") {
              xhr = new XDomainRequest();
              xhr.open(method, url);
            } else {
              // CORS not supported.
              xhr = null;
            }

            if (!xhr) {
              alert('CORS not supported');
              return;
            }

            // Response handlers.
            xhr.onload = function() {


              // parse data
              var data = JSON.parse(xhr.response);

             self.output = d3.csv.parse(data);
            };

            xhr.onerror = function(e) {
              console.log(url);
              console.log(e);
              if(iscors) {
                alert('Woops, there was an error making the request.');
              }
              else {
                var corsurl = self.url.replace(/(ftp|http|https):\/\//,'http://www.corsproxy.com/');
                self._makeCORSCall(corsurl, true);
              }
              //alert('Woops, there was an error making the request.');
            };

            xhr.send();
      },
       
      showControls: function(e) {
          this.$.ctrl_collapse.toggle();
      } ,

      outputChanged: function(){
        console.log("csv output changed");
        this.fire('th-output-changed', this);
      }


      
      });

  </script>
</polymer-element>
